<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

<style>

  .section-header {
    margin: 32px 0;
    padding-bottom: 6px;
    border-bottom: 1px solid #000;
    font-weight: 600;
  }

</style>

<h2 class="section-header">WiFi Info</h2>
<div class="form-group">
  <div class="form-group nowrap">
    <label for="ssid" class="form-label">Nazwa sieci</label>
    <input type="text" id="ssid" name="ssid" placeholder="Wpisz nazwę sieci..." class="form-input">
  </div>

  <div class="form-group nowrap">
    <label for="password" class="form-label">Hasło</label>
    <input type="text" id="password" name="password" placeholder="Wpisz hasło..." class="form-input">
  </div>
</div>

<div class="form-group">
  <div class="form-group">
    <label for="padImage" class="form-label">Włącz Wyświetlanie QR Kodu</label>
    <div class="toggle-container">
      <input type="checkbox" id="padImage" name="padImage" class="toggle-checkbox" value="false">
      <label for="padImage" class="toggle-label"></label>
    </div>
    <!-- Hidden input ensures 'true' is always sent when unchecked -->
    <input type="hidden" name="padImage" value="true">
  </div>

  <div class="form-group">
    <label for="imageUpload" class="form-input file-upload-label">Wybierz Obraz QR Kodu</label>
    <input type="file" clear-on-submit id="imageUpload" name="imageFiles[]" accept="image/*"
           class="file-upload-input" onchange="addFiles()">
  </div>
  <!-- Display uploaded & existing file names -->
  <div class="form-group">
    <div id="fileNames" class="file-name-list"></div>
  </div>
</div>


<h2 class="section-header">Dane wymeldowania</h2>
<div class="form-group">
  <div class="form-group">
    <label for="date" class="form-label">Data wymeldowania</label>
    <input type="date" id="date" name="date" class="form-input" />
  </div>
</div>


<h2 class="section-header">Dane Kontaktowe</h2>
<div class="title-container form-group">
  <label for="contactInfo" class="form-label">Dane kontaktowe do wyświetlenia</label>
  <textarea id="contactInfo" name="contactInfo" placeholder="Wpisz swoje dane kontaktowe do wyświetlenia..."></textarea>
</div>


<h2 class="section-header">Pogoda</h2>

<div class="form-group">
    <label class="form-label">Lokalizacja: </label>
    <div class="form-group">
        <span>Szerokość </span>
        <input readonly type="text" id="latitude" name="latitude" class="form-input" />
    </div>
    <div class="form-group">
        <span>Długość </span>
        <input readonly type="text" id="longitude" name="longitude" class="form-input" />
    </div>
    <button type="button" id="openMap" class="action-button compact">Wybierz Lokalizację</button>
</div>

<div class="form-group">
    <label class="form-label">Dostawca Pogody:</label>
    <span>Open-Meteo</span>

    <label for="units" class="form-label">Jednostki:</label>
    <select id="units" name="units" class="form-input">
        <option value="metric">Metryczne (°C)</option>
        <option value="imperial">Imperialne (°F)</option>
        <option value="standard">Standardowe (K)</option>
    </select>
</div>


<div id="mapModal" class="modal">
    <div class="modal-content">
        <span class="close-button" onclick="closeModal('mapModal')">×</span>
        <h2 id="modalTitle">Wybierz Lokalizację</h2>
        <div class="separator"></div>
        <div id="map" style="width: 100%; height: 200px; margin: 10px 0px;"></div>
        <button id="closeMap" class="action-button">Zapisz</button>
    </div>
</div>

<script>

    document.addEventListener('DOMContentLoaded', () => {

        const OSM_TILE_URL = 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
        const $latitude = document.querySelector('#latitude');
        const $longitude = document.querySelector('#longitude');
        const $openMap = document.querySelector('#openMap');
        const $mapModal = document.querySelector('#mapModal');
        const $closeMap = document.querySelector('#closeMap');

        let latitude = +$latitude.value;
        let longitude = +$longitude.value;
        let zoom = latitude && longitude ? 4.5 : 2.5;
        let selectedTitle = 'location';
        let weatherProvider = 'OpenMeteo';

        let map, marker;

        $openMap.addEventListener('click', () => {
            openModal('mapModal')
            setTimeout(() => {
                if (!map) {
                    map = L.map('map').setView([latitude, longitude], zoom);
                    L.tileLayer(OSM_TILE_URL).addTo(map);
                    marker = L.marker([latitude, longitude], { draggable: true }).addTo(map);

                    map.on('click', event => {
                        marker.setLatLng(event.latlng);
                    });
                }
            }, 100);
        });

        $closeMap.addEventListener('click', () => {
            const position = marker.getLatLng().wrap();
            $latitude.value = position.lat;
            $longitude.value = position.lng;
            closeModal('mapModal');
        });

        if (loadPluginSettings) {
            document.getElementById('latitude').value = pluginSettings.latitude;
            document.getElementById('longitude').value = pluginSettings.longitude;

            document.getElementById('units').value = pluginSettings.units;

            selectedTitle = pluginSettings.titleSelection || 'location';
            weatherProvider = 'OpenMeteo';
        } else {
            // set default values
            document.getElementById('units').value = "metric";
        }

        document.getElementById('weatherProvider').value = weatherProvider;
        document.querySelector(`input[name="titleSelection"][value="${selectedTitle}"]`).checked = true;
    });

    function addFiles() {
      const fileInput = document.getElementById("imageUpload");
      const fileNamesDisplay = document.getElementById("fileNames");

      const files = Array.from(fileInput.files);

      if (!uploadedFiles["imageFiles[]"]) {
        uploadedFiles["imageFiles[]"] = [];
      }

      files.forEach(file => {
        const fileName = file.name;

        // Prevent duplicate files
        if (!uploadedFiles["imageFiles[]"].some(f => f.name === fileName)) {
          uploadedFiles["imageFiles[]"].push(file);

          const fileElement = document.createElement("div");
          fileElement.innerHTML = `
                    <span id="fileNameText">${fileName}</span>
                    <button type="button" class="remove-btn" onclick="removeAddedFile('${fileName}')">X</button>
                `;
          fileElement.id = `added-${fileName}`;
          fileElement.classList.add("file-name");
          fileElement.setAttribute('delete-on-submit', '');
          fileNamesDisplay.appendChild(fileElement);
        }
      });

      // Clear the input to allow adding the same file again if needed
      fileInput.value = "";
    }

    function removeAddedFile(fileName) {
      // Remove the file from uploadedFiles
      uploadedFiles["imageFiles[]"] = uploadedFiles["imageFiles[]"].filter(f => f.name !== fileName);

      // Remove the displayed filename
      document.getElementById(`added-${fileName}`).remove();
    }

    function removeExistingFile(fileName) {
      document.getElementById(`existing-${fileName}`).remove(); // Remove from display
      document.getElementById(`hidden-${fileName}`).remove(); // Remove hidden input
    }

    // populate form values from plugin settings
    document.addEventListener('DOMContentLoaded', () => {
      const fileNamesDisplay = document.getElementById("fileNames");
      const hiddenFileInputs = document.getElementById("hiddenFileInputs");
      let backgroundOption = "blur"
      if (loadPluginSettings) {
        document.getElementById('padImage').checked = pluginSettings.padImage == 'false';
        document.getElementById('randomize').checked = pluginSettings.randomize;
        document.getElementById('backgroundColor').value = pluginSettings.backgroundColor;

        const existingFiles = pluginSettings['imageFiles[]'] || []
        backgroundOption = pluginSettings.backgroundOption || 'blur'

        // Loop through the existing files and add them to the display and hidden inputs
        existingFiles.forEach(filePath => {
          const fileName = filePath.split('/').pop()
          // Create an element for the file name
          const fileElement = document.createElement("div");
          fileElement.innerHTML = `
                    <span id="fileNameText">${fileName}</span>
                    <button type="button" class="remove-btn" onclick="removeExistingFile('${fileName}')">X</button>
                `;
          fileElement.id = `existing-${fileName}`;
          fileElement.classList.add("file-name");
          fileElement.setAttribute('delete-on-submit', '');
          fileNamesDisplay.appendChild(fileElement);

          // Create a hidden input for the existing file
          const hiddenInput = document.createElement("input");
          hiddenInput.type = "hidden";
          hiddenInput.name = "imageFiles[]";
          hiddenInput.value = filePath;
          hiddenInput.id = `hidden-${fileName}`;
          hiddenInput.setAttribute('delete-on-submit', '');
          hiddenFileInputs.appendChild(hiddenInput);
        });
      }
      document.querySelector(`input[name="backgroundOption"][value="${backgroundOption}"]`).checked = true;
    });
</script>
